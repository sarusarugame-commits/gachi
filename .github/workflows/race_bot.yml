name: Boat Race Bot

on:
  schedule:
    # 1. æœã®éƒ¨ (08:30ã€œ)
    - cron: '30 23 * * *'
    # 2. æ˜¼ã®éƒ¨ (14:15ã€œ)
    - cron: '15 5 * * *'
    # 3. å¤œã®éƒ¨ (20:00ã€œ)
    - cron: '0 11 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-race-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # æœ€å¤§6æ™‚é–“ã§å¼·åˆ¶çµ‚äº†ï¼ˆãã‚Œã¾ã§ã¯ãƒ«ãƒ¼ãƒ—ã—ç¶šã‘ã‚‹ï¼‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy lightgbm joblib beautifulsoup4 lxml curl_cffi requests openai scikit-learn

      # â–¼â–¼â–¼ ã“ã“ã‚’ä¿®æ­£ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼†è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ä»˜ãï¼‰ â–¼â–¼â–¼
      - name: Run Bot with Auto-Restart
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONUNBUFFERED: '1'
        run: |
          # Gitã®åˆæœŸè¨­å®šï¼ˆãƒ«ãƒ¼ãƒ—ã®å‰ã«è¡Œã†ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "bot@noreply.github.com"

          echo "ğŸ”„ ç„¡é™ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã§Botã‚’èµ·å‹•ã—ã¾ã™..."

          # ç„¡é™ãƒ«ãƒ¼ãƒ—é–‹å§‹
          while true; do
            echo "------------------------------------------------"
            echo "ğŸš€ Botã‚’èµ·å‹•ã—ã¾ã™"
            echo "------------------------------------------------"
            
            # Pythonã‚’å®Ÿè¡Œ (ã‚¨ãƒ©ãƒ¼ã§ã‚‚å³çµ‚äº†ã—ãªã„ã‚ˆã†ã«ä¸€æ™‚çš„ã« +e)
            set +e
            python main.py
            EXIT_CODE=$?
            set -e
            
            echo "âš ï¸ BotãŒåœæ­¢ã—ã¾ã—ãŸ (Exit Code: $EXIT_CODE)ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒã‚§ãƒƒã‚¯ã—ã¾ã™..."
            
            # â–¼â–¼â–¼ åœæ­¢ã®ãŸã³ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆã“ã“ã«è¿½åŠ ï¼‰ â–¼â–¼â–¼
            git fetch origin main
            git reset --soft origin/main
            git add race_data.db
            
            # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
            if git diff --staged --quiet; then
              echo "å¤‰æ›´ãªã—ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            else
              git commit -m "Auto-save DB after stop [skip ci]"
              git push origin main
              echo "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚"
            fi
            # â–²â–²â–² ä¿å­˜å‡¦ç†çµ‚äº† â–²â–²â–²

            # æ­£å¸¸çµ‚äº†(exit 0)ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã¦çµ‚äº†
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… æ­£å¸¸çµ‚äº†ã®ãŸã‚ã€å†èµ·å‹•ã›ãšã«ã‚¸ãƒ§ãƒ–ã‚’å®Œäº†ã—ã¾ã™ã€‚"
              break
            fi

            echo "ğŸ’¤ ç•°å¸¸çµ‚äº†ã®ãŸã‚ã€10ç§’å¾…æ©Ÿå¾Œã«å†èµ·å‹•ã—ã¾ã™..."
            sleep 10
          done
