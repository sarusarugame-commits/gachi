name: Debug Boat Model

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³
  push:              # pushæ™‚ã«ã‚‚å®Ÿè¡Œ

permissions:
  contents: read

jobs:
  debug-runner:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã«å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¨ç¶²ç¾…ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install pandas numpy lightgbm joblib scikit-learn beautifulsoup4 lxml curl_cffi requests groq

      - name: Create Debug Script
        # è¨ºæ–­ç”¨Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã“ã“ã§ä½œæˆã—ã¾ã™
        run: |
          cat <<EOF > debug_model.py
          import joblib
          import os
          import sys
          import lightgbm
          import pandas
          import numpy
          import traceback

          # scikit-learnãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç¢ºèª
          try:
              import sklearn
              sklearn_version = sklearn.__version__
          except ImportError:
              sklearn_version = "æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"

          MODEL_FILE = 'ultimate_boat_model.pkl'

          print("="*60)
          print("ğŸ” ç’°å¢ƒãƒ»ãƒ¢ãƒ‡ãƒ«è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ")
          print("="*60)

          # 1. ç’°å¢ƒæƒ…å ±ã®è¡¨ç¤º
          print("[1] ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³")
          print(f"Python: {sys.version.split()[0]}")
          print(f"Pandas: {pandas.__version__}")
          print(f"Numpy: {numpy.__version__}")
          print(f"LightGBM: {lightgbm.__version__}")
          print(f"Joblib: {joblib.__version__}")
          print(f"Scikit-learn: {sklearn_version}")

          # 2. ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã¨ã‚µã‚¤ã‚ºç¢ºèª
          print("\n[2] ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«è¨ºæ–­")
          if os.path.exists(MODEL_FILE):
              size = os.path.getsize(MODEL_FILE)
              mb_size = size / (1024*1024)
              print(f"âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™: {MODEL_FILE}")
              print(f"ğŸ“¦ ã‚µã‚¤ã‚º: {mb_size:.2f} MB")
              
              if size < 2000: # 2KBä»¥ä¸‹ãªã‚‰Git LFSãƒã‚¤ãƒ³ã‚¿ã®å¯èƒ½æ€§å¤§
                  print("âš ï¸ ã€è­¦å‘Šã€‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™ï¼Git LFSã®ãƒã‚¤ãƒ³ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
                  with open(MODEL_FILE, 'r', errors='ignore') as f:
                      head = f.read(100)
                      print(f"   ä¸­èº«ã®å…ˆé ­: {head}")
          else:
              print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {MODEL_FILE}")
              print("   -> ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã« .pkl ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
              sys.exit(1)

          # 3. ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
          print("\n[3] ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ")
          try:
              model = joblib.load(MODEL_FILE)
              print("ğŸ‰ æˆåŠŸï¼ãƒ¢ãƒ‡ãƒ«ã¯æ­£å¸¸ã«èª­ã¿è¾¼ã‚ã¾ã—ãŸã€‚")
              print(f"   Model Type: {type(model)}")
              
              if isinstance(model, dict):
                  print(f"   Keys: {list(model.keys())}")
              
          except Exception as e:
              print("ğŸ’€ å¤±æ•—ï¼ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")
              print("-" * 40)
              traceback.print_exc()
              print("-" * 40)
              print("ã€æ¨æ¸¬ã•ã‚Œã‚‹åŸå› ã€‘")
              err_msg = str(e)
              if "ModuleNotFoundError" in err_msg:
                  print("-> å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã«å‡ºã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚")
              elif "attribute" in err_msg or "version" in err_msg:
                  print("-> å­¦ç¿’ç’°å¢ƒ(PC)ã¨å®Ÿè¡Œç’°å¢ƒ(GitHub)ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ä¸€è‡´ã§ã™ã€‚")
              elif "UnpicklingError" in err_msg:
                  print("-> ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€Git LFSãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¾ã¾ã§ã™ã€‚")
          
          print("="*60)
          EOF

      - name: Run Debug
        run: python debug_model.py
